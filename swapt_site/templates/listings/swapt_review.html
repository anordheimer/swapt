{% extends "header.html" %}
{% block header %}
<ul class="nav nav-tabs" id="nav-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="nav-swaptreview-tab" data-bs-toggle="tab" data-bs-target="#nav-swaptreview" type="button" role="tab" aria-controls="nav-swaptreview" aria-selected="true">Awaiting Review</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="nav-swaptswapt-approved-tab" data-bs-toggle="tab" data-bs-target="#nav-swaptapproved" type="button" role="tab" aria-controls="nav-swaptapproved" aria-selected="false">Approved</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="nav-swaptswapt-reported-tab" data-bs-toggle="tab" data-bs-target="#nav-swaptreported" type="button" role="tab" aria-controls="nav-swaptreported" aria-selected="false">Reported</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="nav-swaptswapt-rejected-tab" data-bs-toggle="tab" data-bs-target="#nav-swaptrejected" type="button" role="tab" aria-controls="nav-swaptrejected" aria-selected="false">Rejected</button>
    </li>
</ul>
<div class="form-check form-check-inline">
    <input class="form-check-input location filter" type="checkbox" id="ElonNC">
    <label class="form-check-label" for="ElonNC">
        ElonNC
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input location filter" type="checkbox" id="CollegeParkMD">
    <label class="form-check-label" for="CollegeParkMD">
        CollegeParkMD
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input location filter" type="checkbox" id="BurlingtonNC">
    <label class="form-check-label" for="BurlingtonNC">
        BurlingtonNC
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input location filter" type="checkbox" id="ColumbiaMD">
    <label class="form-check-label" for="ColumbiaMD">
        ColumbiaMD
    </label>
</div>

<br></br>
<div class="form-check form-check-inline">
    <input class="form-check-input campus filter" type="checkbox" id="Elon">
    <label class="form-check-label" for="Elon">
        Elon
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input campus filter" type="checkbox" id="UMD">
    <label class="form-check-label" for="UMD">
        UMD
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input campus filter" type="checkbox" id="UNCG">
    <label class="form-check-label" for="UNCG">
        UNCG
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input propertyname filter" type="checkbox" id="Oaks">
    <label class="form-check-label" for="Oaks">
        Oaks
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input propertyname filter" type="checkbox" id="MillPoint">
    <label class="form-check-label" for="MillPoint">
        MillPoint
    </label>
</div>
<div class="form-check form-check-inline">
    <input class="form-check-input propertyname filter" type="checkbox" id="OakHill">
    <label class="form-check-label" for="OakHill">
        OakHill
    </label>
</div>

<button class="btn btn-success apply-filter">Filter</button>
<div class="tab-content" id="nav-tabContent">   
    <div class="tab-pane fade show active" id="nav-swaptreview" role="tabpanel" aria-labelledby="nav-swaptreview-tab">
        <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for listing in swaptreview %}
        <div class="col">
            <form action="" method="POST">
                {% csrf_token %}
            
                <div class="card" style="width: 18rem;">
                    <div class="card-body">
                    <h5 class="card-title">Awaiting Review</h5>
                    <!-- <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> -->
                    </div>
                    <ul class="list-group list-group-flush">
                    <li class="list-group-item">Name: {{ listing.title }}</li>
                    <li class="list-group-item">Description: {{ listing.desc }}</li>
                    <li class="list-group-item card-location">Location: {{listing.location}}</li>
                    {% if listing.issue != None %}
                    <li class="list-group-item">Reported/rejected issue: {{ listing.issue }}</li>
                    {% endif %}
                    {% for pair in listing.swaptcampuspropertynamepair_set.all %}
                    <li class="list-group-item card-propertyname">Campus/propertyname pair {{ forloop.counter }}: {{ pair.campus }}/{{ pair.propertyname }}</li>
                    {% endfor %}
                    </ul>
                    <div class="card-body">
                        {% if user.is_admin %}
                            {% if listing.stage != 2 %}
                            <button type="submit" value="2" class="btn btn-success" name="status">Approve</button>
                            {% endif %}
                            {% if listing.stage == 1 %}
                            {% comment %} <button type="submit" value="3" class="btn btn-danger" name="status">Reject</button> {% endcomment %}
                            <a class="btn btn-danger" href="{% url 'listings:swapt_reject' listing.id %}?next={% url 'listings:swapt_review'%}#nav-swaptreview-tab" role="button">Reject</a>
                            {% else %}
                            <button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button>
                            {% endif %}
                        <a class="btn btn-primary" href="{% url 'listings:swapt_edit' listing.id %}?next={% url 'listings:swapt_review'%}#nav-swaptreview-tab" role="button">Edit</a>
                        {% elif listing.stage != 2 and user.is_swapt_user %}
                        <a class="btn btn-primary" href="{% url 'listings:swapt_edit' listing.id %}?next={% url 'listings:swapt_review'%}#nav-swaptreview-tab" role="button">Edit</a>
                        <button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button>
                        {% endif %}
                        <input type="hidden" name="id" value={{ listing.id }}>
                    </div>
                </div>
            </form>
        </div>
        {% endfor %}
        </div>
    </div>
    <div class="tab-pane fade" id="nav-swaptapproved" role="tabpanel" aria-labelledby="nav-swaptswapt-approved-tab">
        <table id="swapt-approved-table" class="table table-bordered">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Location</th>
                    <th scope="col">Campus Level 1</th>
                    <th scope="col">Propertyname Level 1</th>
                    <th scope="col">Campus Level 2</th>
                    <th scope="col">Propertyname Level 2</th>
                    <th scope="col">Campus Level 3</th>
                    <th scope="col">Propertyname Level 3</th>
                    <th scope="col">Buttons</th>
                </tr>
            </thead>
        </table>
    </div>
    <div class="tab-pane fade" id="nav-swaptreported" role="tabpanel" aria-labelledby="nav-swaptswapt-reported-tab">
        <table id="swapt-reported-table" class="table table-bordered">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Location</th>
                    <th scope="col">Issue</th>
                    <th scope="col">Campus Level 1</th>
                    <th scope="col">Propertyname Level 1</th>
                    <th scope="col">Campus Level 2</th>
                    <th scope="col">Propertyname Level 2</th>
                    <th scope="col">Campus Level 3</th>
                    <th scope="col">Propertyname Level 3</th>
                    <th scope="col">Buttons</th>
                </tr>
            </thead>
        </table>
    </div> 
    <div class="tab-pane fade" id="nav-swaptrejected" role="tabpanel" aria-labelledby="nav-swaptswapt-rejected-tab">
        <table id="swapt-rejected-table" class="table table-bordered">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Location</th>
                    <th scope="col">Issue</th>
                    <th scope="col">Campus Level 1</th>
                    <th scope="col">Propertyname Level 1</th>
                    <th scope="col">Campus Level 2</th>
                    <th scope="col">Propertyname Level 2</th>
                    <th scope="col">Campus Level 3</th>
                    <th scope="col">Propertyname Level 3</th>
                    <th scope="col">Buttons</th>
                </tr>
            </thead>
        </table>
    </div>
    {% if user.is_admin %}
    <div class="tab-pane fade" id="nav-swapt" role="tabpanel" aria-labelledby="nav-swapt-tab">
        <table id="swapt-table" class="table table-bordered">
            <thead>
                <tr>
                    <th scope="col">swapt</th>
                </tr>
            </thead>
        </table>
    </div>
    {% endif %}
</div>
<script>
$(document).ready(function () {

    var filter = ""
    if (window.location.search.substring(1) != "") {
        filter = "&" + window.location.search.substring(1);
        var params = window.location.search.substring(1).split("&");
        for(let i = 0; i < params.length; i ++) {
            param = params[i];
            
            if(param.startsWith("location") || param.startsWith("propertyname")) {
                $("#" + param.split("=")[1]).prop("checked", true);
            } else if(param.startsWith("showNA")) {
                stringBool = param.split("=")[1] == "true"
                $("#na").prop("checked", stringBool);
            }
        }
    } else {
        $('input[type=checkbox]').each(function () {
            $(this).prop("checked", true);
        });
    }

    var approvedTable = $('#swapt-approved-table').DataTable({
        "serverSide": true,
        "processing": true,
        "autoWidth": false,
        "stateSave": true,
        "ajax": {
            "url": "/listings/api/review/?format=datatables&stage=2" + filter,
            "credentials": 'include',
        },
        "columns": [
            {"data": "title"},
            {"data": "desc"},
            {
                "searchable": false,
                "data": "location"
            },
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.campus'
            },
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.propertyname'
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.propertyname',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.propertyname',
            },
            {
                "searchable": false,
                "data": null,
                render:function(data, type, row) {
                    return '<div class="d-inline"> <form action="" method="POST"> {% csrf_token %} <button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button> <input type="hidden" class="card-id" name="id" value="' + data["id"] + '"> </form> </div> <div class="d-inline"> <a class="btn btn-primary" role="button">Edit</a> </div>';
                },
                "targets": -1,
               
            }
        ],
    });
 
    var column = approvedTable.column(10);
    column.visible({% if user.is_admin %} true {% else %} false {% endif %});

    $('#swapt-approved-table tbody').on('click', 'a', function () {
        var data = approvedTable.row( $(this).parents('tr') ).data();
        window.location.href = window.location.origin + "/listings/edit/" + data["id"] + "?next=/listings/review/#nav-swaptswapt-approved-tab";
    } );

    var reportedTable = $('#swapt-reported-table').DataTable({
        "serverSide": true,
        "processing": true,
        "autoWidth": false,
        "stateSave": true,
        "ajax": {
            "url": "/listings/api/review/?format=datatables&stage=4" + filter,
            "credentials": 'include',
        },
        "columns": [
            {"data": "title"},
            {"data": "desc"},
            {
                "searchable": false,
                "data": "location"
            },
            {"data": "issue"},
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.campus'
            },
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.propertyname'
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.propertyname',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.propertyname',
            },
            {
                "data": null,
                render:function(data, type, row) {
                    return '<div class="d-inline"> <form action="" method="POST"> {% csrf_token %} {% if user.is_admin %} <button type="submit" value="2" class="btn btn-success" name="status">Approve</button> {% endif %}<button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button> <input type="hidden" class="card-id" name="id" value="' + data["id"] + '"> </form> </div> <div class="d-inline"> <a class="btn btn-primary" role="button">Edit</a> </div>';
                },
                "targets": -1
            }
        ],
    });

    $('#swapt-reported-table tbody').on('click', 'a', function () {
        console.log("Test");
        var data = reportedTable.row( $(this).parents('tr') ).data();
        window.location.href = window.location.origin + "/listings/edit/" + data["id"] + "?next=/listings/review/#nav-swaptswapt-reported-tab";
    } );

    var rejectedTable = $('#swapt-rejected-table').DataTable({
        "serverSide": true,
        "processing": true,
        "autoWidth": false,
        "stateSave": true,
        "ajax": {
            "url": "/listings/api/review/?format=datatables&stage=3" + filter,
            "credentials": 'include',
        },
        "columns": [
            {"data": "title"},
            {"data": "desc"},
            {
                "searchable": false,
                "data": "location"
            },
            {"data": "issue"},
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.campus'
            },
            {
                "searchable": false,
                "data": 'swaptcampuspropertynamepair_set.0.propertyname'
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.1.propertyname',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.campus',
            },
            {
                "searchable": false,
                "defaultContent": "",
                "data": 'swaptcampuspropertynamepair_set.2.propertyname',
            },
            {
                "data": null,
                render:function(data, type, row) {
                    return '<div class="d-inline"> <form action="" method="POST"> {% csrf_token %} {% if user.is_admin %} <button type="submit" value="2" class="btn btn-success" name="status">Approve</button> {% endif %}<button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button> <input type="hidden" class="card-id" name="id" value="' + data["id"] + '"> </form> </div> <div class="d-inline"> <a class="btn btn-primary" role="button">Edit</a> </div>';
                },
                "targets": -1
            }
        ],
    });

    $('#swapt-rejected-table tbody').on('click', 'a', function () {
        var data = rejectedTable.row( $(this).parents('tr') ).data();
        window.location.href = window.location.origin + "/listings/edit/" + data["id"] + "?next=/listings/review/#nav-swaptswapt-rejected-tab";
    } );

    var swaptTable = $('#swapt-table').DataTable({
        "serverSide": true,
        "processing": true,
        "autoWidth": false,
        "stateSave": true,
        "ajax": {
            "url": "/listings/api/review/?format=datatables&stage=5",
            "credentials": 'include',
        },
        "columns": [
            {"data": "title"},
            {
                "data": null,
                render:function(data, type, row) {
                    return '<div class="d-inline"> <form action="" method="POST"> {% csrf_token %} {% if user.is_admin %} <button type="submit" value="delete" class="btn btn-danger" name="status">Delete</button> <input type="hidden" class="card-id" name="id" value="' + data["id"] + '"> </form> </div> {% endif %}';
                },
                "targets": -1
            }
        ],
        
    });
});


$('.apply-filter').click(function (e){submit(e)});

function submit(e){
    var locations = [];
    var propertynames = [];
    var campuses = [];

    $(".location").each(function () {
        if ($(this).is(":checked")) { locations.push($(this).attr('id').toString()); }
    });

    $(".propertyname").each(function () {
        if ($(this).is(":checked")) { propertynames.push($(this).attr('id').toString()); }
    });
    $(".campus").each(function () {
        if ($(this).is(":checked")) { campuses.push($(this).attr('id').toString()); }
    });



    

    var showNA = $('#na').is(":checked").toString();

    var href = "?location=";
    for(let i = 0; i < locations.length; i++) {
        if(i != 0) {
            href += "&location=" + locations[i];
        } else {
            href += locations[i];
        }
    }
    for(let i = 0; i < propertynames.length; i++) {
        href += "&propertyname=" + propertynames[i];
    }
    href += "&showNA=" + showNA;
    window.location.href = href + location.hash;
}

// store the currently selected tab in the hash value
$("ul.nav-tabs > li > button").on("shown.bs.tab", function(e) {
  var id = $(e.target).attr("id");
  // localStorage.setItem('selectedTab', id);
  if(history.pushState) {
    history.pushState(null, null, "#" + id);
  } else {
    location.hash = "#" + id;
  }
  //window.location.hash = id;
});

// on load of the page: switch to the currently selected tab
var hash = location.hash;

var tabShowEl = document.querySelector(hash);
var tabShow = new bootstrap.Tab(tabShowEl);
tabShow.show();

</script>
{% endblock %}